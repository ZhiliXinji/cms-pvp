{% extends "contest.html" %}

{% set page = "overview" %}

{% block core %}
<div class="container">
<div class="mb-5">
  <h1 class="display-4 fw-bold text-primary mb-3 text-center">{% trans %}Overview{% endtrans %}</h1>
  <hr class="w-25 mx-auto border-primary opacity-75">
</div>

<section class="mb-5">
  <h2 class="h3 mb-4 text-secondary">{% trans %}General information{% endtrans %}</h2>

  <div class="row">
    <div class="col-12">
      <div class="{% if contest.per_user_time is not none %}col-lg-8{% else %}col-12{% endif %}">
        <div class="card shadow border-0" style="max-width: 100%; overflow-x: hidden;">
          <div class="card-body">
            {% if phase == -1 %}
              <div class="alert alert-info">
                <p class="mb-0">{% trans %}The contest hasn't started yet.{% endtrans %}</p>
              </div>
              <p class="lead">
                {% trans start_time=(contest.start + participation.delay_time)|format_datetime_smart,
                        stop_time=(contest.stop + participation.delay_time + participation.extra_time)|format_datetime_smart %}
                  The contest will start at <strong>{{ start_time }}</strong> and will end at <strong>{{ stop_time }}</strong>.
                {% endtrans %}
              </p>
            {% elif phase == 0 %}
              <div class="alert alert-success">
                <p class="mb-0">{% trans %}The contest is currently running.{% endtrans %}</p>
              </div>
              <p class="lead">
                {% trans start_time=(contest.start + participation.delay_time)|format_datetime_smart,
                        stop_time=(contest.stop + participation.delay_time + participation.extra_time)|format_datetime_smart %}
                  The contest started at <strong>{{ start_time }}</strong> and will end at <strong>{{ stop_time }}</strong>.
                {% endtrans %}
              </p>
            {% elif phase >= +1 %}
              <div class="alert alert-warning">
                <p class="mb-0">{% trans %}The contest has already ended.{% endtrans %}</p>
              </div>
              <p class="lead">
                {% trans start_time=(contest.start + participation.delay_time)|format_datetime_smart,
                        stop_time=(contest.stop + participation.delay_time + participation.extra_time)|format_datetime_smart %}
                  The contest started at <strong>{{ start_time }}</strong> and ended at <strong>{{ stop_time }}</strong>.
                {% endtrans %}
              </p>
            {% endif %}

            {% if tokens_contest != TOKEN_MODE_DISABLED and tokens_tasks != TOKEN_MODE_DISABLED %}
              <div class="mt-4 p-3 bg-light rounded">
                {{ _build_token_section() }}
              </div>
            {% endif %}

            <div class="mt-4">
              {% if contest.max_submission_number is not none %}
                <p class="mb-2">
                  <i class="bi bi-file-earmark-arrow-up me-2"></i>
                  {% trans submissions=contest.max_submission_number %}Maximum submissions: <strong>{{ submissions }}</strong>{% endtrans %}
                </p>
              {% endif %}

              {% if contest.max_user_test_number is not none %}
                <p class="mb-0">
                  <i class="bi bi-gear me-2"></i>
                  {% trans user_tests=contest.max_user_test_number %}Maximum user tests: <strong>{{ user_tests }}</strong>{% endtrans %}
                </p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {% if contest.per_user_time is not none %}
        <div class="col-lg-4">
          <div class="card shadow border-danger">
            <div class="card-body">
              <h3 class="h5 mb-3 text-danger">
                <i class="bi bi-clock-history me-2"></i>
                {% trans %}Time Frame{% endtrans %}
              </h3>

              <p class="small">
                {% trans per_user_time=contest.per_user_time|format_timedelta %}
                  Available time: <strong>{{ per_user_time }}</strong>
                {% endtrans %}
              </p>

              {{ _build_time_frame_alert(actual_phase) }}

              {% if actual_phase == -1 %}
                <form action="{{ contest_url("start") }}" method="POST" class="mt-3">
                  {{ xsrf_form_html|safe }}
                  <input type="hidden" name="next" value="{{ contest_url() }}">
                  <button type="submit" class="btn btn-danger w-100 d-flex align-items-center justify-content-center">
                    <i class="bi bi-play-circle me-2"></i>
                    {% trans %}Start Now{% endtrans %}
                  </button>
                </form>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</section>

{% if actual_phase == 0 or actual_phase == 3 %}
<section>
  <h2 class="h3 mb-4 text-secondary">{% trans %}Task Overview{% endtrans %}</h2>

  <div class="card shadow border-0" style="max-width: 100%; overflow-x: hidden;">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 rounded-3" style="table-layout: fixed;">
          <thead class="table-light">
            <tr>
              <th>{% trans %}Task{% endtrans %}</th>
              <th>{% trans %}Name{% endtrans %}</th>
              <th>{% trans %}Time Limit{% endtrans %}</th>
              <th>{% trans %}Memory Limit{% endtrans %}</th>
              <th>{% trans %}Type{% endtrans %}</th>
              <th>{% trans %}Files{% endtrans %}</th>
              {% if tokens_contest != TOKEN_MODE_DISABLED and tokens_tasks != TOKEN_MODE_DISABLED %}
              <th>{% trans %}Tokens{% endtrans %}</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% set extensions = "[%s]"|format(contest.languages|map("to_language")|map(attribute="source_extension")|unique|join("|")) %}
            {% for t_iter in contest.tasks %}
            <tr>
              <td class="fw-bold">{{ t_iter.name }}</td>
              <td>{{ t_iter.title }}</td>
              <td>
                {% if t_iter.active_dataset.time_limit is not none %}
                  {{ t_iter.active_dataset.time_limit|format_duration(length="long") }}
                {% else %}
                  <span class="text-muted">{% trans %}N/A{% endtrans %}</span>
                {% endif %}
              </td>
              <td>
                {% if t_iter.active_dataset.memory_limit is not none %}
                  {{ t_iter.active_dataset.memory_limit|format_size }}
                {% else %}
                  <span class="text-muted">{% trans %}N/A{% endtrans %}</span>
                {% endif %}
              </td>
              <td><span class="badge bg-primary">{{ get_task_type(dataset=t_iter.active_dataset).name }}</span></td>
              <td><code>{{ t_iter.submission_format|map("replace", ".%l", extensions)|join(" ") }}</code></td>
              {% if tokens_contest != TOKEN_MODE_DISABLED and tokens_tasks != TOKEN_MODE_DISABLED %}
              <td>
                {% if t_iter.token_mode == TOKEN_MODE_FINITE or t_iter.token_mode == TOKEN_MODE_INFINITE %}
                  <i class="bi bi-check-circle-fill text-success"></i>
                {% else %}
                  <i class="bi bi-x-circle-fill text-danger"></i>
                {% endif %}
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
{% endif %}
</div>
{% endblock core %}

{% macro _build_token_section() %}
{% if tokens_contest == TOKEN_MODE_INFINITE and tokens_tasks == TOKEN_MODE_INFINITE %}
  <p class="mb-2">
    <i class="bi bi-infinity me-2"></i>
    {% trans %}Unlimited tokens available{% endtrans %}
  </p>
  <p class="small text-muted mb-0">
    {% trans %}Score calculation: Maximum between token-used submissions and last submission{% endtrans %}
  </p>
{% elif tokens_contest == TOKEN_MODE_INFINITE %}
  <p class="mb-2">
    <i class="bi bi-asterisk me-2"></i>
    {% trans %}Task-specific token rules{% endtrans %}
  </p>
{% elif tokens_tasks == TOKEN_MODE_INFINITE %}
  <p class="mb-2">
    <i class="bi bi-share me-2"></i>
    {% trans %}Shared contest tokens{% endtrans %}
  </p>
{% else %}
  <p class="mb-2">
    <i class="bi bi-layers me-2"></i>
    {% trans %}Dual token system (contest + task){% endtrans %}
  </p>
{% endif %}
{% endmacro %}

{% macro _build_time_frame_alert(actual_phase) %}
<div class="alert alert-{{ 'info' if actual_phase < 0 else 'secondary' }} mt-3">
  {% if actual_phase == -2 %}
    <p class="small mb-0">{% trans %}Time frame selection available at contest start{% endtrans %}</p>
  {% elif actual_phase == -1 %}
    <p class="small mb-0">{% trans %}Click the button below to begin your time frame{% endtrans %}</p>
  {% elif actual_phase == 0 %}
    <p class="small mb-0">
      {% trans start_time=participation.starting_time|format_datetime_smart %}
        Started at: <strong>{{ start_time }}</strong>
      {% endtrans %}
    </p>
  {% elif actual_phase >= +1 %}
    {% if participation.starting_time is none %}
      <p class="small mb-0 text-danger">{% trans %}No time frame started{% endtrans %}</p>
    {% else %}
      <p class="small mb-0">
        {% trans start_time=participation.starting_time|format_datetime_smart %}
          Completed at: <strong>{{ start_time }}</strong>
        {% endtrans %}
      </p>
    {% endif %}
  {% endif %}
</div>
{% endmacro %}
